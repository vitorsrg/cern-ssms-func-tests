################################################################################
#
################################################################################

apiVersion: v1
kind: Pod
metadata:
  name: always-fails
spec:
  containers:
    - name: main
      image: bash:5.0.17
      command:
        - /usr/local/bin/bash
        - "${source_path}/src/test/always_fails.sh"
      env:
        - name: source_path
          value: "!ch.cern{source_path}"
      resources:
        requests:
          memory: "1Gi"
          cpu: "500m"
        limits:
          memory: "4Gi"
          cpu: "1"
      volumeMounts:
        - name: func-tests-src
          mountPath: "!ch.cern{source_path}"
          readOnly: true
  initContainers:
    - name: clone-source
      image: registry.cern.ch/vsantaro/func-tests
      command: [/bin/bash]
      args:
        - -c
        - |
          #!/bin/bash

          set -ex

          git clone \
            "https://oauth2:${gitlab_token}@${gitlab_url}" \
            --branch vitorsrg \
            --single-branch \
            --depth 1 \
            ${source_path}
      env:
        - name: gitlab_token
          value: "!ch.cern{gitlab_token}"
        - name: gitlab_url
          value: "!ch.cern{gitlab_url}"
        - name: source_path
          value: "!ch.cern{source_path}"
      mirrorVolumeMounts: true
  volumes:
    - name: func-tests-src
      emptyDir: {}
